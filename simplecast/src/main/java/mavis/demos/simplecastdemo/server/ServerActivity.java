package mavis.demos.simplecastdemo.server;import android.app.Service;import android.content.ComponentName;import android.content.Intent;import android.content.ServiceConnection;import android.media.projection.MediaProjectionManager;import android.os.Bundle;import android.os.IBinder;import android.view.View;import android.widget.TextView;import androidx.annotation.Nullable;import androidx.appcompat.app.AppCompatActivity;import mavis.demos.simplecastdemo.R;public class ServerActivity extends AppCompatActivity {    private static final int PROJECTION_REQUEST_CODE = 1;    private MediaProjectionManager mediaProjectionManager;    private TextView mIpAddress;    private ScreenService mScreenService;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_server);        mIpAddress = findViewById(R.id.tv_ip);        init();    }    @Override    protected void onResume() {        super.onResume();        if (mScreenService != null) {            mIpAddress.setText(mScreenService.getIpAddress());        }    }    private void init() {        mediaProjectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE);    }    public void onClick(View view) {        if (view.getId() == R.id.btn_start) {            startProjection();        }        if (view.getId() == R.id.btn_stop) {            if (mScreenService != null) {                mScreenService.stopProjection();                mScreenService.stopSelf();            }        }    }    // 请求开始录屏    private void startProjection() {        Intent intent = mediaProjectionManager.createScreenCaptureIntent();        startActivityForResult(intent, PROJECTION_REQUEST_CODE);    }    @Override    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {        super.onActivityResult(requestCode, resultCode, data);        if (resultCode != RESULT_OK) {            return;        }        if (requestCode == PROJECTION_REQUEST_CODE) {            Intent service = new Intent(this, ScreenService.class);            service.putExtra("code", resultCode);            service.putExtra("data", data);            bindService(service, new ServiceConnection() {                @Override                public void onServiceConnected(ComponentName name, IBinder service) {                    mScreenService = ((ScreenService.LocalBinder) service).getService();                }                @Override                public void onServiceDisconnected(ComponentName name) {                }            }, Service.BIND_AUTO_CREATE);            startForegroundService(service);        }    }    @Override    protected void onDestroy() {        super.onDestroy();    }}